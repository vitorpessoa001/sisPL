<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assessoria - Plen√°rio da C√¢mara dos Deputados</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  <style>
    .item-header {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; color: #006633; font-weight: 600; font-size: 0.95rem; padding: 0.3rem 0;
    }
    .item-header:hover { color: #004d26; }
    .item-info { font-size: 0.85rem; color: #555; }
    .collapse-toggle-icon { transition: transform 0.3s ease; }
    .collapse.show + .item-header .collapse-toggle-icon,
    .item-header[aria-expanded="true"] .collapse-toggle-icon { transform: rotate(180deg); }
    .secao-badge {
      font-size: 0.75rem;
      padding: 0.3em 0.5em;
      border-radius: 0.3rem;
      margin-left: 10px;
      color: #fff !important;
    }
    .secao-badge.bg-warning { color: #000 !important; }
    .secao-badge.bg-primary { background-color: #0d6efd !important; }
    .secao-badge.bg-info { background-color: #17a2b8 !important; }
    .secao-badge.bg-success { background-color: #28a745 !important; }
    .secao-badge.bg-warning { background-color: #ffc107 !important; }
    .secao-badge.bg-secondary { background-color: #6c757d !important; }
    .last-updated {
      font-size: 0.75rem;
      color: #6c757d;
      margin-left: 10px;
    }

    .editor-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 0.9rem;
      color: #333;
      font-style: italic;
    }
    .editor-spinner {
      margin: 10px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="alert text-center py-1 mb-0" 
     style="font-size:0.85rem; background-color:#b5d3bc; color:#4d5d4d; border:1px solid #dbe3da;">
    ‚ö†Ô∏è Ambiente de desenvolvimento ‚Äî dados e an√°lises podem conter erros.
  </div>

  <div class="header">
    <div class="container header-wrap d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <div class="header-logos me-3">
          <img src="/static/logo_camara.png" alt="Logo da C√¢mara" class="logo">
          <img src="/static/logo_pl.jpg" alt="Logo do PL" class="logo-pl mt-2">
        </div>
        <div class="header-text">
          <h1 class="titulo-app mb-0">Assessoria</h1>
          <p class="subtitulo-app mb-0">Plen√°rio da C√¢mara dos Deputados</p>
        </div>
      </div>
      <div class="text-end">
        <a href="{{ url_for('usuarios.logout') }}" class="btn btn-outline-light btn-sm mb-1">
          <i class="fas fa-sign-out-alt me-2"></i>Sair
        </a><br>
        <small class="text-light">{{ current_user.username }}</small>
        {% if current_user.is_authenticated and current_user.role == 'Admin' %}
          <a href="{{ url_for('usuarios.admin_usuarios') }}" 
            class="btn btn-sm mb-1 ms-1"
            style="color: rgba(255,255,255,0.5); border: none;"
            onmouseover="this.style.color='#ffc107'" 
            onmouseout="this.style.color='rgba(255,255,255,0.5)'">
            <i class="fas fa-cog"></i>
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="container my-4">
    <div class="sessao-info p-3 bg-light border rounded mb-3">
      <h5 class="mb-2"><i class="fas fa-users text-success me-2"></i>Sess√£o Deliberativa</h5>
      {% if from_cache %}
      <div class="alert alert-warning text-center py-2 mb-3" style="font-size: 0.9rem;">
        üîÅ Exibindo vers√£o em cache ‚Äî dados indispon√≠veis ou inst√°veis no momento.
      </div>
      {% endif %}
      <div class="small text-muted">
        <strong><i class="far fa-clock me-1"></i>Data/Hora:</strong>
        {{ evento.dataHoraInicio | default('N/D') | replace('T', ' ') | datetimeformat('%d/%m/%Y %H:%M') if evento.dataHoraInicio != 'N/D' else 'N/D' }}<br>
        <strong><i class="fas fa-info-circle me-1"></i>Situa√ß√£o:</strong>
        <span class="badge {{ 'bg-success' if evento.situacao|default('')|lower == 'em andamento' else 'bg-secondary' }}">
          {{ evento.situacao | default('N/D') }}
        </span><br>
        <strong><i class="fas fa-align-left me-1"></i>Descri√ß√£o:</strong> {{ evento.descricao | default('Sem descri√ß√£o') }}<br>
        <strong><i class="fas fa-map-marker-alt me-1"></i>Local:</strong> {{ evento.local | default('N/D') }}
      </div>
    </div>

    <div class="d-flex align-items-center">
      <a href="{{ url_for('selecionar_data') }}" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="fas fa-arrow-left me-2"></i>Voltar para Sele√ß√£o de Data
      </a>
      <a href="{{ url_for('view_pauta', evento_id=evento_id, force_reload='true') }}" class="btn btn-outline-primary btn-sm mb-3 ms-2">
        <i class="fas fa-sync-alt me-2"></i>Atualizar Pauta
      </a>
      {% if last_updated %}
      <small class="last-updated mb-3">Atualizado em {{ last_updated | datetimeformat('%d/%m/%Y %H:%M') }}</small>
      {% endif %}
    </div>

    {% if itens %}
      {% for item in itens %}
      <div class="item-card mb-3">
        <div class="card-body">
          <div class="item-header" data-bs-toggle="collapse" data-bs-target="#col-{{ item.ordem }}" aria-expanded="false">
            <div>
              <i class="fas fa-file-alt text-primary me-2"></i>
              Item {{ item.ordem }} ‚Äî {{ item.projeto }} ‚Äî <strong>Autor:</strong> {{ item.autor }}
              <span class="badge secao-badge 
                {{ 'bg-primary' if item.status in ['Proposta em An√°lise', 'Propostas em An√°lise'] else 
                   'bg-info' if item.status in ['Proposta Prevista', 'Propostas Previstas'] else 
                   'bg-success' if item.status in ['Proposta Analisada', 'Propostas Analisadas'] else 
                   'bg-warning text-dark' if item.status in ['Proposta N√£o Analisada', 'Propostas N√£o Analisadas'] else 
                   'bg-secondary' }}">
                {{ item.status | default('N/D') }}
              </span>
              <div class="item-info mt-1">
                <strong>Situa√ß√£o:</strong> {{ item.situacao | default('N/D') }} &nbsp;&nbsp;
                <strong>Relator:</strong> {{ item.relator }}
              </div>
            </div>
            <i class="fas fa-chevron-down collapse-toggle-icon ms-2"></i>
          </div>

          <div class="collapse" id="col-{{ item.ordem }}">
            <hr class="mt-2 mb-2">
            <div class="small text-muted mb-2">
              <strong>Ementa:</strong> {{ item.ementa }}<br>
            </div>

            {% if user_role == 'Assessor' %}
              <!-- üü° MODO LEITURA -->
              <div class="mt-2">
                <label class="form-label small"><strong>Resumo/Nota T√©cnica:</strong></label>
                <div class="p-2 border rounded bg-light" style="min-height:150px; white-space:pre-wrap;">
                  {{ item.resumo_materia | safe }}
                </div>
              </div>

              <div class="mt-2">
                <label class="form-label small"><strong>Orienta√ß√£o:</strong></label><br>
                <span class="badge bg-secondary">{{ item.orientacao or '‚Äî' }}</span>
              </div>

              {% if item.destaques_emendas %}
              <div class="mt-4">
                <h6><i class="fas fa-thumbtack text-warning me-2"></i>Destaques e Emendas Aglutinativas</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>N√∫mero</th><th>Autoria</th><th>Descri√ß√£o</th><th>Tipo Destaque</th><th>Situa√ß√£o</th><th>Resumo</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in item.destaques_emendas %}
                      <tr>
                        <td><strong>{{ d.numero }}</strong></td>
                        <td>{{ d.autoria }}</td>
                        <td>{{ d.descricao }}</td>
                        <td>{{ d.tipo_destaque }}</td>
                        <td><span class="badge {{ 'bg-warning' if d.situacao|lower == 'em tramita√ß√£o' else 'bg-secondary' }}">{{ d.situacao }}</span></td>
                        <td style="white-space:pre-wrap;">{{ d.resumo_nota | safe }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endif %}

            {% else %}
              <!-- üîµ EDI√á√ÉO PARA ADMIN E ASSESSOR PLEN√ÅRIO -->
              <div class="mt-2">
                <label class="form-label small"><strong>Gerar sugest√£o de an√°lise (Projeto principal):</strong></label>
                <div class="input-group mb-2">
                  <input type="text" id="numero_pl_{{ item.ordem }}" class="form-control" placeholder="Ex: PL 4363/2025">
                  <button class="btn btn-outline-primary btn-gerar-analise" type="button" onclick="gerarAnalise('{{ item.ordem }}', this)">
                    <img src="/static/logo_gpt.png" alt="GPT" class="icon-gpt me-2">
                    Gerar An√°lise
                  </button>
                </div>
                <small class="text-muted">A an√°lise ser√° inserida automaticamente no campo de Resumo/Nota T√©cnica.</small>
              </div>

              <div class="mt-2 position-relative">
                <label class="form-label small"><strong>Resumo/Nota T√©cnica:</strong></label>
                <textarea id="editor-resumo-materia-{{ item.ordem }}" class="editable-field">{% if item.resumo_materia %}{{ item.resumo_materia | safe }}{% endif %}</textarea>
                <div id="overlay-{{ item.ordem }}" class="editor-overlay" style="display:none;">
                  <div class="editor-spinner"></div>
                  <p>üìÑ Acessando o PDF do inteiro teor...<br>üß† Gerando sugest√£o de nota t√©cnica...</p>
                </div>
              </div>

              <div class="mt-2">
                <label class="form-label small"><strong>Orienta√ß√£o:</strong></label>
                <select class="form-control editable-field orientacao" data-ordem="{{ item.ordem }}">
                  <option value="" {% if not item.orientacao %}selected{% endif %}>Selecione</option>
                  <option value="NEGOCIA√á√ÉO" {% if item.orientacao == 'NEGOCIA√á√ÉO' %}selected{% endif %}>NEGOCIA√á√ÉO</option>
                  <option value="SIM" {% if item.orientacao == 'SIM' %}selected{% endif %}>SIM</option>
                  <option value="N√ÉO" {% if item.orientacao == 'N√ÉO' %}selected{% endif %}>N√ÉO</option>
                  <option value="LIBERADO" {% if item.orientacao == 'LIBERADO' %}selected{% endif %}>LIBERADO</option>
                  <option value="OBSTRU√á√ÉO" {% if item.orientacao == 'OBSTRU√á√ÉO' %}selected{% endif %}>OBSTRU√á√ÉO</option>
                  <option value="ABSTEN√á√ÉO" {% if item.orientacao == 'ABSTEN√á√ÉO' %}selected{% endif %}>ABSTEN√á√ÉO</option>
                </select>
              </div>

              {% if item.destaques_emendas %}
              <div class="mt-4">
                <h6><i class="fas fa-thumbtack text-warning me-2"></i>Destaques e Emendas Aglutinativas</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>N√∫mero</th><th>Autoria</th><th>Descri√ß√£o</th><th>Tipo Destaque</th><th>Situa√ß√£o</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in item.destaques_emendas %}
                      <tr>
                        <td><strong>{{ d.numero }}</strong></td>
                        <td>{{ d.autoria }}</td>
                        <td>{{ d.descricao }}</td>
                        <td>{{ d.tipo_destaque }}</td>
                        <td><span class="badge {{ 'bg-warning' if d.situacao|lower == 'em tramita√ß√£o' else 'bg-secondary' }}">{{ d.situacao }}</span></td>
                      </tr>
                      <tr>
                        <td colspan="5">
                          <label class="form-label small"><strong>Resumo/Nota T√©cnica ‚Äî {{ d.numero }}:</strong></label>
                          <textarea id="editor-resumo-destaque-{{ item.ordem }}-{{ loop.index }}" class="editable-field" data-numero="{{ d.numero }}">{% if d.resumo_nota %}{{ d.resumo_nota | safe }}{% endif %}</textarea>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endif %}

              <button class="btn btn-primary btn-sm save-btn mt-3"
                      data-ordem="{{ item.ordem }}"
                      data-id-principal="{{ item.id_principal }}">Salvar</button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info">Nenhum item encontrado na pauta para este evento.</div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.tiny.cloud/1/s5oe6o875r9q481981gj71glbo9pb4pjr3mawioi8akazfhw/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    tinymce.init({
      selector: '.editable-field:not(.orientacao)',
      menubar: false,
      height: 250,
      plugins: 'lists link image table code',
      toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist | table link image | code',
      branding: false,
      language: 'pt_BR'
    });
  });

  async function gerarAnalise(ordem, btn) {
    const numeroInput = document.getElementById("numero_pl_" + ordem);
    const numero = numeroInput.value.trim();
    const overlay = document.getElementById("overlay-" + ordem);

    if (!numero) {
      alert("Digite o n√∫mero do PL (ex: PL 4363/2025)");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Gerando...";

    overlay.style.display = "flex";

    try {
      const resposta = await fetch("/api/analisar_pl?numero=" + encodeURIComponent(numero));
      const texto = await resposta.text();

      const editor = tinymce.get("editor-resumo-materia-" + ordem);
      if (editor) {
        editor.setContent(
          `<p><strong>An√°lise gerada automaticamente:</strong></p>
          <div style="margin-top:8px; line-height:1.6;">${texto}</div>`
        );
      }

      alert("‚úÖ An√°lise gerada e inserida com sucesso!");
    } catch (e) {
      console.error(e);
      alert("‚ö†Ô∏è Erro ao gerar an√°lise. Verifique a conex√£o.");
    } finally {
      overlay.style.display = "none";
      btn.disabled = false;
      btn.textContent = "Gerar An√°lise";
    }
  }

  document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const ordem = btn.dataset.ordem;
      const idPrincipal = btn.dataset.idPrincipal;
      const editorResumoMateria = tinymce.get(`editor-resumo-materia-${ordem}`);
      const resumoMateria = editorResumoMateria ? editorResumoMateria.getContent() : '';
      const orientacaoEl = document.querySelector(`.orientacao[data-ordem="${ordem}"]`);
      const orientacao = orientacaoEl ? orientacaoEl.value : '';

      const destaques = [];
      document.querySelectorAll(`[id^="editor-resumo-destaque-${ordem}-"]`).forEach(el => {
        const numero = el.dataset.numero || '';
        const editor = tinymce.get(el.id);
        if (editor && numero) {
          destaques.push({ numero, resumo: editor.getContent() });
        }
      });

      const dataToSend = {
        evento_id: {{ evento_id|safe }},
        ordem,
        id_principal: idPrincipal,
        resumo_materia: resumoMateria,
        orientacao,
        resumo_parecer: '',
        destaques
      };

      try {
        const r = await fetch('/save_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataToSend)
        });
        const j = await r.json();
        alert(j.message || 'Salvo com sucesso!');
      } catch (error) {
        console.error("Erro ao salvar item:", error);
        alert('Erro ao salvar: falha na conex√£o.');
      }
    });
  });
  </script>
</body>
</html>
